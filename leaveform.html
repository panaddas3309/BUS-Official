<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  const LIFF_ID = "2007956727-rbZz9a0z"; // ใส่ LIFF ID ของคุณ
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkFIZc4BcOy9GqN9KyaJosXpfjgklM3LW-b4Na2F-2pofoFeiGqaKGwKxpauNnv0pt/exec";

  async function init() {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) liff.login();

    const profile = await liff.getProfile();
    const userId = profile.userId;

    let res = await fetch(`${SCRIPT_URL}?lineUserId=${userId}`);
    let data = await res.json();

    if (data.bound) {
      document.getElementById("employeeName").value = data.name;
      document.getElementById("employeeId").value = data.employeeId;

      const submitBtn = document.getElementById("submitBtn");
      const alertBox = document.getElementById("alertBox");

      submitBtn.addEventListener("click", function(e) {
        e.preventDefault();
        const leaveType = document.getElementById("leaveType").value;
        const startDate = document.getElementById("startDate").value;
        const startTime = document.getElementById("startTime").value;
        const endDate = document.getElementById("endDate").value;
        const endTime = document.getElementById("endTime").value;

        if (!leaveType || !startDate || !startTime || !endDate || !endTime) {
          alertBox.style.display = "block";
          alertBox.textContent = "กรุณากรอกข้อมูลให้ครบถ้วน";
          return;
        }

        // ตรวจสอบสิทธิ์ลา
        let remaining = 0;
        if (leaveType === "vacation") remaining = data.vacation;
        if (leaveType === "sick") remaining = data.personal;
        if (leaveType === "personal") remaining = data.sick;

        if (remaining <= 0) {
          alertBox.style.display = "block";
          alertBox.textContent = `คุณใช้สิทธิ์ลา ${document.querySelector("#leaveType option:checked").textContent} หมดแล้ว`;
          return;
        }

        alertBox.style.display = "none";
        submitBtn.disabled = true;

        const leaveRequest = {
          employeeId: data.employeeId,
          name: data.name,
          type: leaveType,
          reason: document.getElementById("reason").value,
          from: `${startDate} ${startTime}`,
          to: `${endDate} ${endTime}`
        };

        console.log("ส่งคำขอลา:", leaveRequest);
        alert("ส่งคำขอลาสำเร็จ!");
      });
    } else {
      alert("บัญชีผู้ใช้ยังไม่ได้ผูก กรุณากลับไปหน้า Dashboard");
      location.href = "dashboard.html";
    }
  }

  init();
</script>
